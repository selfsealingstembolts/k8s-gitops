---
data_dir: /vector-data-dir
api:
  enabled: true
  address: 0.0.0.0:8686
  playground: false
sources:
  internal_metrics:
    type: internal_metrics
  vector:
    address: 0.0.0.0:6000
    type: vector
    version: "2"
transforms:
  kubernetes-transform:
    type: remap
    inputs:
      - vector
    source: |
      if .source_type == "kubernetes_logs" {
        .log = parse_json(.message) ?? .message
        .node = .kubernetes.pod_node_name
        .namespace = .kubernetes.pod_namespace
        .pod = .kubernetes.pod_name
        .image = .kubernetes.container_image
        .container = .kubernetes.container_name
        .pod_ip = .kubernetes.pod_ip
        .pod_ips = .kubernetes.pod_ips
        del(.file)
        del(.kubernetes.container_id)
        del(.kubernetes.container_image_id)
        del(.kubernetes.pod_annotations)
        del(.kubernetes.namespace_labels)
        del(.kubernetes.node_labels)
      }

sinks:
  prom_exporter:
    type: prometheus_exporter
    inputs:
      - internal_metrics
    address: 0.0.0.0:9090
  victorialogs:
    type: loki
    inputs:
      - kubernetes-transform
    endpoint: "http://vlogs.k8s.example.com/insert/loki/"
    compression: gzip
    path: "/api/v1/push?_msg_field=message,msg,_msg,log.msg,log.message,log&_time_field=timestamp&_stream_fields=source,source_type,stream,cluster,node,namespace"
    encoding:
      codec: json
    labels:
      source: vector
      source_type: "{{ .source_type }}"
      stream: "{{ .stream }}"
      cluster: workload-prod
      node: "{{ .node }}"
      namespace: "{{ .namespace }}"
