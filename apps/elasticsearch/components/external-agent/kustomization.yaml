---
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

patches:
  - target:
      kind: Agent
      name: fleet-server
      namespace: elastic
    patch: |-
      apiVersion: agent.k8s.elastic.co/v1alpha1
      kind: Agent
      metadata:
        name: fleet-server
        namespace: elastic
      spec:
        http:
          service:
            metadata:
              annotations:
                external-dns.alpha.kubernetes.io/hostname: ""
            spec:
              type: LoadBalancer
              allocateLoadBalancerNodePorts: true
              externalTrafficPolicy: Cluster
          tls:
            certificate:
              secretName: fleet-tls

  - target:
      name: kibana
      kind: Kibana
      namespace: elastic
    patch: |-
      - op: add
        path: "/spec/config/xpack/fleet/packages/-"
        value:
          name: endpoint
          version: latest
      - op: add
        path: "/spec/config/xpack/fleet/agentPolicies/-"
        value:
          name: External Agent policy
          id: external-agent
          monitoring_enabled:
            - logs
            - metrics
          package_policies:
            - package:
                name: system
              name: system-external
            - package:
                name: endpoint
              name: defend-external
